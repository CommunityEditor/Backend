<link rel="icon" href="/favicon.ico">

<script>
    var link = document.createElement("link");
    link.setAttribute("rel", "stylesheet");
    link.setAttribute("type", "text/css");
    link.setAttribute("href", "/static/styles/user-info.css");
    document.head.appendChild(link);
</script>

<div id="user-info">
    <span class="user-info-element">
        <button id="user-links-button" class="user-info-button">{{ request.user.profile.display_name|default:"Not Logged In" }}</button>

        <div id="user-links" style="display: none">
            {% if request.user.is_authenticated %}
                <a class="link" href="/user/{{ request.user.username }}">@{{ request.user.username }}</a>
                <a class="link" href="/">Home</a>
                <a class="link" href="/user/logout">Log Out</a>
            {% else %}
                <a class="link" href="/">Home</a>
                <a class="link" href="/user/login?next={{ request.path|urlencode }}">Log In</a>
            {% endif %}
        </div>
    </span><!--

    --><span class="user-info-element">
        <button id="notif-panel-button" class="user-info-button">Notifs (<span id="notif-count">0</span>)</button>

        <div id="notif-panel" class="closed">
            <div class="notif-buttons-wrap">
                <button class="user-info-button notif-button" id="notif-all-read">Mark All Read</button><button class="user-info-button notif-button" id="notif-panel-close-button">Close</button>
            </div>

            <div id="notifs-wrap">
            </div>
        </div>
    </span>

    <script>
        {% load notifications %}

        userData = {
            {% if request.user.is_authenticated %}
                "loggedIn": true,
                "username": "{{ request.user.username|escapejs }}",
                "id": "{{ request.user.profile.profile_id|escapejs }}",
                "displayName": "{{ request.user.profile.display_name|escapejs }}",
                "notifications": JSON.parse('{% notifs_as_json request.user %}')
            {% else %}
                "loggedIn": false,
            {% endif %}
        };

        document.addEventListener("DOMContentLoaded", function () {
            var userLinksOpen = false;
            var userLinks = document.getElementById("user-links");
            document.getElementById("user-links-button").addEventListener("click", function () {
                userLinks.style.display = userLinksOpen ? "none" : "block";
                userLinksOpen = !userLinksOpen;
            });

            var notifPanel = document.getElementById("notif-panel");
            document.getElementById("notif-panel-button").addEventListener("click", function () {
                notifPanel.classList.toggle("closed");
            });
            document.getElementById("notif-panel-close-button").addEventListener("click", function () {
                notifPanel.classList.toggle("closed");
            });

            var notifs = userData.notifications;
            var notifsWrap = document.getElementById("notifs-wrap");
            for (var i = 0; i < notifs.length; i++) {
                var notifEl = document.createElement("a");
                notifEl.setAttribute("href", notifs[i].link);
                notifEl.classList.add("notif");

                var readIndicator = document.createElement("span");
                readIndicator.classList.add("read-indicator");
                if (notifs[i].read) {
                    readIndicator.classList.add("read");
                }
                readIndicator.addEventListener("click", function () {

                });

                var notifInfo = document.createElement("span");
                notifInfo.classList.add("notif-info-wrap");

                var description = document.createElement("div");
                description.classList.add("notif-description");
                description.innerHTML = notifs[i].description;

                var preview = document.createElement("div");
                preview.classList.add("notif-preview")
                preview.innerText = notifs[i].preview;

                notifEl.appendChild(readIndicator);
                notifInfo.appendChild(description);
                notifInfo.appendChild(preview);
                notifsWrap.appendChild(notifEl).appendChild(notifInfo);
            }
        });
    </script>
</div>
